<?php/* *  创建订单编号 * */if (!function_exists('createOrderNo')) {    function createOrderNo()    {        $sn = date('Ymd') . time() . random(4, true);        return $sn;    }}// 本机url转换为本地路径/** * $src = url */if (!function_exists('url2local')) {    function url2local($src, $domain = '')    {        global $_W;        //支持以下格式        //$src = 'http://vxb.wifigs.com/attachment/images/1/2020/10/T7tjWDAgTTZfFFZKWhwgWWrkhFHGrI.png';        //$src = 'http://vxb.wifigs.com/addons/gf_xxx/T7tjWDAgTTZfFFZKWhwgWWrkhFHGrI.png';        //$src = 'addons/gf_xxx/20/10/T7tjWDAgTTZfFFZKWhwgWWrkhFHGrI.png';        //$src = 'images/1/2020/10/T7tjWDAgTTZfFFZKWhwgWWrkhFHGrI.png';        //$path = tomedia($url, true);        if (empty($domain)) {            $domain = $_W['siteroot'];    // 末尾有斜杆        } else {            ;        }        if (strexists($src, $domain) && strexists($src, 'addons/')) {            //echo 'A: ' . IA_ROOT . '/' . substr($src, strpos($src, 'addons/'));            return IA_ROOT . '/' . substr($src, strpos($src, 'addons/'));        }        if (!strexists($src, $domain) && strexists($src, 'addons/')) {            //echo 'A: ' . IA_ROOT . '/' . $src;            return IA_ROOT . '/' . $src;        }        if (strexists($src, $domain) && strexists($src, 'images/')) {            $urls = parse_url($src);            //var_dump($urls);            $src = $t = substr($urls['path'], strpos($urls['path'], 'images'));            //echo 'B: ' . ATTACHMENT_ROOT  . $src;            return ATTACHMENT_ROOT . $src;        }        if (!strexists($src, $domain) && strexists($src, 'images/')) {            //$urls = parse_url($src);            //var_dump($urls);            //$src = $t = substr($urls['path'], strpos($urls['path'], 'images'));            //echo 'C: ' . ATTACHMENT_ROOT  . $src;            return ATTACHMENT_ROOT . $src;        }    }}if (!function_exists('isWeixin')) {    function isWeixin()    {        if (strpos($_SERVER['HTTP_USER_AGENT'], 'MicroMessenger') !== false) {            return true;        } else {            return false;        }    }}if (!function_exists('isMobile')) {    function isMobile()    {        // 如果有HTTP_X_WAP_PROFILE则一定是移动设备        if (isset($_SERVER['HTTP_X_WAP_PROFILE'])) {            return true;        }        // 如果via信息含有wap则一定是移动设备,部分服务商会屏蔽该信息        if (isset($_SERVER['HTTP_VIA'])) {            // 找不到为flase,否则为true            return stristr($_SERVER['HTTP_VIA'], "wap") ? true : false;        }        // 判断手机发送的客户端标志,兼容性有待提高。其中'MicroMessenger'是电脑微信        if (isset($_SERVER['HTTP_USER_AGENT'])) {            $clientkeywords = array('nokia', 'sony', 'ericsson', 'mot', 'samsung', 'htc', 'sgh', 'lg', 'sharp', 'sie-', 'philips', 'panasonic', 'alcatel', 'lenovo', 'iphone', 'ipod', 'blackberry', 'meizu', 'android', 'netfront', 'symbian', 'ucweb', 'windowsce', 'palm', 'operamini', 'operamobi', 'openwave', 'nexusone', 'cldc', 'midp', 'wap', 'mobile', 'MicroMessenger');            // 从HTTP_USER_AGENT中查找手机浏览器的关键字            if (preg_match("/(" . implode('|', $clientkeywords) . ")/i", strtolower($_SERVER['HTTP_USER_AGENT']))) {                return true;            }        }        // 协议法，因为有可能不准确，放到最后判断        if (isset ($_SERVER['HTTP_ACCEPT'])) {            // 如果只支持wml并且不支持html那一定是移动设备            // 如果支持wml和html但是wml在html之前则是移动设备            if ((strpos($_SERVER['HTTP_ACCEPT'], 'vnd.wap.wml') !== false) && (strpos($_SERVER['HTTP_ACCEPT'], 'text/html') === false || (strpos($_SERVER['HTTP_ACCEPT'], 'vnd.wap.wml') < strpos($_SERVER['HTTP_ACCEPT'], 'text/html')))) {                return true;            }        }        return false;    }}/** * 隐藏手机号 */if (!function_exists('yc_mobile')) {    function yc_mobile($mobile, $index = 3, $starcount = 8)    {        //return substr_replace($mobile, '*****', 3, 5);        return substr_replace($mobile, '********', $index, $starcount);    }}/** * 返回指定范围内的随机数 */if (!function_exists('randomFloat')) {    function randomFloat($min = 0, $max = 1, $decimals = 2)    {        $res = $min + mt_rand() / mt_getrandmax() * ($max - $min);        return number_format($res, $decimals);    }}//if (!function_exists('mobileUrl')) {    function mobileUrl($do = '', $query = NULL, $full = false)    {        global $_W;        global $_GPC;        !$query && ($query = array());        if (!empty($do)) {            $query = array_merge(array('do' => $do), $query);        }        if ($full) {            return $_W['siteroot'] . 'app/' . substr(murl('entry', $query, true), 2);        }        return murl('entry', $query, true);    }}/** * 删除指定目录下的文件夹和文件 */if (!function_exists('deleteDir')) {    function deleteDir($dir, $delself = false)    {        if (!is_dir($dir)) {            return true;        }        if (!$handle = @opendir($dir)) {            return false;        }        while (false !== ($file = readdir($handle))) {            //排除当前目录与父级目录            if ($file !== "." && $file !== "..") {                $file = $dir . '/' . $file;                if (is_dir($file)) {                    deleteDir($file);                } else {                    @unlink($file);                }            }        }        if ($delself) {            @rmdir($dir);    // 删除当前空文件夹        }        return true;    }}/** * 下载远程图片并返回保存后的完整路径 * $savepath 本地路径不带后缀名 */if (!function_exists('download_remote_pic')) {    function download_remote_pic($url, $savepath, $ext = 'jpg')    {        $header = [            'User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:45.0) Gecko/20100101 Firefox/45.0',            'Accept-Language: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3',            'Accept-Encoding: gzip, deflate',        ];        $curl = curl_init();        curl_setopt($curl, CURLOPT_URL, $url);        curl_setopt($curl, CURLOPT_RETURNTRANSFER, true);        curl_setopt($curl, CURLOPT_FOLLOWLOCATION, true);        curl_setopt($curl, CURLOPT_ENCODING, 'gzip');        curl_setopt($curl, CURLOPT_HTTPHEADER, $header);        $data = curl_exec($curl);        $code = curl_getinfo($curl, CURLINFO_HTTP_CODE);        curl_close($curl);        if ($code == 200) {//把URL格式的图片转成base64_encode格式的            $imgBase64Code = "data:image/jpeg;base64," . base64_encode($data);        }        $img_content = $imgBase64Code;//图片内容        //echo $img_content;exit;        if (preg_match('/^(data:\s*image\/(\w+);base64,)/', $img_content, $result)) {            file_put_contents(MODULE_ROOT . '/temp/remote_pic.txt', var_export($result, true));            $type = $result[2];//得到图片类型png?jpeg?gif?            //$new_file = "./".time().rand(1,10000).".{$type}";            //if(empty($ext)){            //	$new_file = $savepath . "." . $type;            //}else{            $new_file = $savepath . "." . $ext;            //}            if (file_put_contents($new_file, base64_decode(str_replace($result[1], '', $img_content)))) {                return $new_file;            }        }    }}/** * 合成2张图片并返回完整路径 * $savepath不带'/' */if (!function_exists('composeImg')) {    function composeImg($src, $bgimg, $savepath)    {        $target = imagecreatetruecolor(640, 640);        $bg = imagecreatefromjpeg($src);        //imagecopy($target, $bg, 0, 0, 0, 0, 640, 640);        imagecopyresized($target, $bg, 0, 0, 0, 0, 640, 640, imagesx($bg), imagesy($bg));        imagedestroy($bg);        $bgimg = imagecreatefrompng($bgimg);        imagecopyresized($target, $bgimg, 0, 0, 0, 0, 640, 640, imagesx($bgimg), imagesy($bgimg));        imagedestroy($bgimg);        $savename = $savepath . "-new.jpg";        imagejpeg($target, $savename);    // 合成后保存到文件        imagedestroy($target);        return $savename;    }}/** * 导出数据到xls文件 * */if (!function_exists('exportexcel')) {    function exportexcel($title = array(), $data = array(), $filename = 'xx.xls')    {        header("Content-type:application/octet-stream");        header("Accept-Ranges:bytes");        header("Content-type:application/vnd.ms-excel");        header("Content-Disposition:attachment;filename=" . $filename);        header("Pragma: no-cache");        header("Expires: 0");        //导出xls 开始        if (!empty($title)) {            foreach ($title as $k => $v) {                $title[$k] = iconv("UTF-8", "GBK", $v);            }            $title = implode("\t", $title);            echo "$title\n";        }        if (!empty($data)) {            foreach ($data as $key => $val) {                foreach ($val as $ck => $cv) {                    $data[$key][$ck] = iconv("UTF-8", "GBK", $cv);                }                $data[$key] = implode("\t", $data[$key]);            }            echo implode("\n", $data);        }    }}/** * hex2rgb */if (!function_exists('hex2rgb')) {    function hex2rgb($hex)    {        $hex = substr($hex, -6); // 去除#        $dou = str_split($hex, 2);        return array(            hexdec($dou[0]),            hexdec($dou[1]),            hexdec($dou[2])        );    }}if (!function_exists('is_weixin')) {    function is_weixin()    {        global $_W;        $useragent = addslashes($_SERVER['HTTP_USER_AGENT']);        if (strpos($useragent, 'MicroMessenger') === false && strpos($useragent, 'Windows Phone') === false) {            $url = "http://qr.liantu.com/api.php?text=" . urlencode("http://" . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI']);            $html = '<html><head><meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" /><title>只能在微信中打开</title><meta name="format-detection" content="telephone=no, address=no" /><meta name="apple-mobile-web-app-capable" content="yes" /><meta name="apple-touch-fullscreen" content="yes" /></head><body><style>.codeImage table{margin:0 auto;}</style><div class="box" style=" padding-top:1.5rem;min-height:18.45rem;"><div class="codeImage" style="text-align: center;"><img src="' . $url . '" alt="placeholder+image"></div><div class="info" style="margin:auto 0;margin-top:20px;color:#666;text-align: center;font-size: 28px;">请用手机微信扫描二维码</div></div><script>(function(){var s="_"+Math.random().toString(36).slice(2);document.write(\'<div id="\'+s+\'"></div>\');(window.slotbydup=window.slotbydup||[]).push({id:"4345361",container:s,size:"20,3",display:"inlay-fix"})})();</script><script src="http://dup.baidustatic.com/js/om.js"></script></body></html>';            echo $html;            exit;        }    }}/** * blog:http://www.zhaokeli.com * 处理圆角图片 * @param  string $imgpath 源图片路径 * @param  integer $radius 圆角半径长度默认为15,处理成圆型 * @return [type]           [description] *///header("content-type:image/png");//$imgg = radius_img('./tt.png', 20);//imagepng($imgg);//imagedestroy($imgg);if (!function_exists('radius_img')) {    function radius_img($imgpath = './test.jpg', $radius = 10)    {        $ext = pathinfo($imgpath);        $src_img = null;        switch ($ext['extension']) {            case 'jpg':                $src_img = imagecreatefromjpeg($imgpath);                break;            case 'png':                $src_img = imagecreatefrompng($imgpath);                break;        }        $wh = getimagesize($imgpath);        $w = $wh[0];        $h = $wh[1];        // $radius = $radius == 0 ? (min($w, $h) / 2) : $radius;        $img = imagecreatetruecolor($w, $h);        //这一句一定要有        imagesavealpha($img, true);        //拾取一个完全透明的颜色,最后一个参数127为全透明        $bg = imagecolorallocatealpha($img, 255, 255, 255, 127);        imagefill($img, 0, 0, $bg);        $r = $radius; //圆 角半径        for ($x = 0; $x < $w; $x++) {            for ($y = 0; $y < $h; $y++) {                $rgbColor = imagecolorat($src_img, $x, $y);                if (($x >= $radius && $x <= ($w - $radius)) || ($y >= $radius && $y <= ($h - $radius))) {                    //不在四角的范围内,直接画                    imagesetpixel($img, $x, $y, $rgbColor);                } else {                    //在四角的范围内选择画                    //上左                    $y_x = $r; //圆心X坐标                    $y_y = $r; //圆心Y坐标                    if (((($x - $y_x) * ($x - $y_x) + ($y - $y_y) * ($y - $y_y)) <= ($r * $r))) {                        imagesetpixel($img, $x, $y, $rgbColor);                    }                    //上右                    $y_x = $w - $r; //圆心X坐标                    $y_y = $r; //圆心Y坐标                    if (((($x - $y_x) * ($x - $y_x) + ($y - $y_y) * ($y - $y_y)) <= ($r * $r))) {                        imagesetpixel($img, $x, $y, $rgbColor);                    }                    //下左                    $y_x = $r; //圆心X坐标                    $y_y = $h - $r; //圆心Y坐标                    if (((($x - $y_x) * ($x - $y_x) + ($y - $y_y) * ($y - $y_y)) <= ($r * $r))) {                        imagesetpixel($img, $x, $y, $rgbColor);                    }                    //下右                    $y_x = $w - $r; //圆心X坐标                    $y_y = $h - $r; //圆心Y坐标                    if (((($x - $y_x) * ($x - $y_x) + ($y - $y_y) * ($y - $y_y)) <= ($r * $r))) {                        imagesetpixel($img, $x, $y, $rgbColor);                    }                }            }        }        return $img;    }}// JS-SDK, 增加开发标签if (!function_exists('register_jssdk_plus')) {    function register_jssdk_plus($debug = false)    {        global $_W;        if (defined('HEADER')) {            echo '';            return;        }        $sysinfo = array(            'uniacid' => $_W['uniacid'],            'acid' => $_W['acid'],            'siteroot' => $_W['siteroot'],            'siteurl' => $_W['siteurl'],            'attachurl' => $_W['attachurl'],            'cookie' => array('pre' => $_W['config']['cookie']['pre'])        );        if (!empty($_W['acid'])) {            $sysinfo['acid'] = $_W['acid'];        }        if (!empty($_W['openid'])) {            $sysinfo['openid'] = $_W['openid'];        }        if (defined('MODULE_URL')) {            $sysinfo['MODULE_URL'] = MODULE_URL;        }        $sysinfo = json_encode($sysinfo);        $jssdkconfig = json_encode($_W['account']['jssdkconfig']);        $debug = $debug ? 'true' : 'false';        $script = <<<EOF        <script src="http://res.wx.qq.com/open/js/jweixin-1.6.0.js"></script>        <script type="text/javascript">            window.sysinfo = window.sysinfo || $sysinfo || {};                        // jssdk config 对象            jssdkconfig = $jssdkconfig || {};                        // 是否启用调试            jssdkconfig.debug = $debug;                        jssdkconfig.jsApiList = [                'checkJsApi',                'onMenuShareTimeline',                'onMenuShareAppMessage',                'onMenuShareQQ',                'onMenuShareWeibo',                'hideMenuItems',                'showMenuItems',                'hideAllNonBaseMenuItem',                'showAllNonBaseMenuItem',                'translateVoice',                'startRecord',                'stopRecord',                'onRecordEnd',                'playVoice',                'pauseVoice',                'stopVoice',                'uploadVoice',                'downloadVoice',                'chooseImage',                'previewImage',                'uploadImage',                'downloadImage',                'getNetworkType',                'openLocation',                'getLocation',                'hideOptionMenu',                'showOptionMenu',                'closeWindow',                'scanQRCode',                'chooseWXPay',                'openProductSpecificView',                'addCard',                'chooseCard',                'openCard'            ];                        jssdkconfig.openTagList = ['wx-open-launch-weapp'];	// 小程序跳转按钮                        wx.config(jssdkconfig);                    </script>    EOF;        echo $script;        }}if (!function_exists('debug')) {         function debug($file, $data)    {        if (!file_exists(MODULE_ROOT . '/temp/')) {            mkdir(MODULE_ROOT . '/temp/', 0777);        }        file_put_contents(MODULE_ROOT . '/temp/' . $file, var_export($data, true));    }}if (!function_exists('dump')) {         function dump($var,$exit=true)    {        echo '<pre>';        var_dump($var);        echo '</pre>';        if($exit){            exit;        }    }}